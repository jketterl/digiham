#include "rrc_filter.hpp"

using namespace Digiham::RrcFilter;

RrcFilter::RrcFilter(unsigned int nZeros, double gain, const float coeffs[]):
    nZeros(nZeros),
    gain(gain),
    coeffs(coeffs),
    delay((float*) malloc(sizeof(float) * (nZeros + 1)))
{}

RrcFilter::~RrcFilter() {
    free(delay);
}

void RrcFilter::process(float* input, float* output, size_t length) {
    for (size_t i = 0; i < length; i++) {
        output[i] = filter(input[i]);
    }
}

float RrcFilter::filter(float sample) {
    float sum = 0.0f;

    for (int i = 0; i < nZeros; i++)
        delay[i] = delay[i+1];

    delay[nZeros] = sample; // unfiltered sample in

    for (int i = 0; i <= nZeros; i++)
        sum += (coeffs[i] * delay[i]);

    return sum / gain; // filtered sample out
}

/* Digital filter designed by mkfilter/mkshape/gencode   A.J. Fisher
   Command line: ./mkshape -r 3e-02 2.0e-01 161 -w -x -l */

NarrowRrcFilter::NarrowRrcFilter():
    RrcFilter(160, 1.667711971e+01,
              (const float[]) {
                      -0.0008965127, -0.0006084266, -0.0002629259, +0.0001376901,
                      +0.0005891423, +0.0010840181, +0.0016105739, +0.0021516457,
                      +0.0026838327, +0.0031771176, +0.0035950725, +0.0038957679,
                      +0.0040334554, +0.0039610403, +0.0036332901, +0.0030106572,
                      +0.0020635228, +0.0007766025, -0.0008467956, -0.0027810092,
                      -0.0049751193, -0.0073512625, -0.0098044779, -0.0122043473,
                      -0.0143986008, -0.0162187503, -0.0174876896, -0.0180290597,
                      -0.0176780431, -0.0162931143, -0.0137681562, -0.0100442577,
                      -0.0051204456, +0.0009374242, +0.0079903670, +0.0158232514,
                      +0.0241456376, +0.0325968938, +0.0407558163, +0.0481547523,
                      +0.0542979823, +0.0586838603, +0.0608299644, +0.0603002781,
                      +0.0567332283, +0.0498692532, +0.0395764841, +0.0258730951,
                      +0.0089449258, -0.0108429006, -0.0329414440, -0.0566213193,
                      -0.0809844704, -0.1049844817, -0.1274551627, -0.1471467396,
                      -0.1627685874, -0.1730370678, -0.1767267207, -0.1727227994,
                      -0.1600729711, -0.1380359261, -0.1061246612, -0.0641423317,
                      -0.0122087987, +0.0492236806, +0.1193667582, +0.1971049660,
                      +0.2810174958, +0.3694123940, +0.4603722307, +0.5518097911,
                      +0.6415318736, +0.7273088884, +0.8069476569, +0.8783646253,
                      +0.9396566353, +0.9891664557, +1.0255404526, +1.0477760738,
                      +1.0552572221, +1.0477760738, +1.0255404526, +0.9891664557,
                      +0.9396566353, +0.8783646253, +0.8069476569, +0.7273088884,
                      +0.6415318736, +0.5518097911, +0.4603722307, +0.3694123940,
                      +0.2810174958, +0.1971049660, +0.1193667582, +0.0492236806,
                      -0.0122087987, -0.0641423317, -0.1061246612, -0.1380359261,
                      -0.1600729711, -0.1727227994, -0.1767267207, -0.1730370678,
                      -0.1627685874, -0.1471467396, -0.1274551627, -0.1049844817,
                      -0.0809844704, -0.0566213193, -0.0329414440, -0.0108429006,
                      +0.0089449258, +0.0258730951, +0.0395764841, +0.0498692532,
                      +0.0567332283, +0.0603002781, +0.0608299644, +0.0586838603,
                      +0.0542979823, +0.0481547523, +0.0407558163, +0.0325968938,
                      +0.0241456376, +0.0158232514, +0.0079903670, +0.0009374242,
                      -0.0051204456, -0.0100442577, -0.0137681562, -0.0162931143,
                      -0.0176780431, -0.0180290597, -0.0174876896, -0.0162187503,
                      -0.0143986008, -0.0122043473, -0.0098044779, -0.0073512625,
                      -0.0049751193, -0.0027810092, -0.0008467956, +0.0007766025,
                      +0.0020635228, +0.0030106572, +0.0036332901, +0.0039610403,
                      +0.0040334554, +0.0038957679, +0.0035950725, +0.0031771176,
                      +0.0026838327, +0.0021516457, +0.0016105739, +0.0010840181,
                      +0.0005891423, +0.0001376901, -0.0002629259, -0.0006084266,
                      -0.0008965127,
              })
{}

/* Digital filter designed by mkfilter/mkshape/gencode   A.J. Fisher
   Command line: ./mkshape -r 6e-02 2.0e-01 81 -w -l */

WideRrcFilter::WideRrcFilter():
    RrcFilter(80, 8.337797030e+00,
              (const float[]) {
                      -0.0008938217, -0.0002609230, +0.0005898982, +0.0016095188,
                      +0.0026805019, +0.0035892828, +0.0040255371, +0.0036242975,
                      +0.0020553299, -0.0008516117, -0.0049736668, -0.0097942071,
                      -0.0143781385, -0.0174576799, -0.0176417629, -0.0137316693,
                      -0.0050921107, +0.0080011038, +0.0241300735, +0.0407081846,
                      +0.0542175970, +0.0607228306, +0.0566126484, +0.0394623171,
                      +0.0088613798, -0.0329693214, -0.0809351463, -0.1273151201,
                      -0.1625361486, -0.1764143887, -0.1597076656, -0.1057455528,
                      -0.0118628528, +0.1196309860, +0.2811569136, +0.4603559944,
                      +0.6413467573, +0.8066010425, +0.9391765221, +1.0249723677,
                      +1.0546584365, +1.0249723677, +0.9391765221, +0.8066010425,
                      +0.6413467573, +0.4603559944, +0.2811569136, +0.1196309860,
                      -0.0118628528, -0.1057455528, -0.1597076656, -0.1764143887,
                      -0.1625361486, -0.1273151201, -0.0809351463, -0.0329693214,
                      +0.0088613798, +0.0394623171, +0.0566126484, +0.0607228306,
                      +0.0542175970, +0.0407081846, +0.0241300735, +0.0080011038,
                      -0.0050921107, -0.0137316693, -0.0176417629, -0.0174576799,
                      -0.0143781385, -0.0097942071, -0.0049736668, -0.0008516117,
                      +0.0020553299, +0.0036242975, +0.0040255371, +0.0035892828,
                      +0.0026805019, +0.0016095188, +0.0005898982, -0.0002609230,
                      -0.0008938217,

              })
{}