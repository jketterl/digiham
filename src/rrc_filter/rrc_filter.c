#include <unistd.h>
#include <stdio.h>
#include <getopt.h>
#include <stdbool.h>
#include "version.h"

#define BUF_SIZE 256

/* Digital filter designed by mkfilter/mkshape/gencode   A.J. Fisher
   Command line: ./mkshape -r 6e-02 2.0e-01 81 -w -l */

#define WIDE_ZEROS 80
#define WIDE_GAIN   8.337797030e+00

static float wide_delay[WIDE_ZEROS+1];

static float wide_coeffs[] =
  { -0.0008938217, -0.0002609230, +0.0005898982, +0.0016095188,
    +0.0026805019, +0.0035892828, +0.0040255371, +0.0036242975,
    +0.0020553299, -0.0008516117, -0.0049736668, -0.0097942071,
    -0.0143781385, -0.0174576799, -0.0176417629, -0.0137316693,
    -0.0050921107, +0.0080011038, +0.0241300735, +0.0407081846,
    +0.0542175970, +0.0607228306, +0.0566126484, +0.0394623171,
    +0.0088613798, -0.0329693214, -0.0809351463, -0.1273151201,
    -0.1625361486, -0.1764143887, -0.1597076656, -0.1057455528,
    -0.0118628528, +0.1196309860, +0.2811569136, +0.4603559944,
    +0.6413467573, +0.8066010425, +0.9391765221, +1.0249723677,
    +1.0546584365, +1.0249723677, +0.9391765221, +0.8066010425,
    +0.6413467573, +0.4603559944, +0.2811569136, +0.1196309860,
    -0.0118628528, -0.1057455528, -0.1597076656, -0.1764143887,
    -0.1625361486, -0.1273151201, -0.0809351463, -0.0329693214,
    +0.0088613798, +0.0394623171, +0.0566126484, +0.0607228306,
    +0.0542175970, +0.0407081846, +0.0241300735, +0.0080011038,
    -0.0050921107, -0.0137316693, -0.0176417629, -0.0174576799,
    -0.0143781385, -0.0097942071, -0.0049736668, -0.0008516117,
    +0.0020553299, +0.0036242975, +0.0040255371, +0.0035892828,
    +0.0026805019, +0.0016095188, +0.0005898982, -0.0002609230,
    -0.0008938217,
  };

float wide_rrc_filter(float sample) {
  float sum; int i;

  for (i = 0; i < WIDE_ZEROS; i++)
      wide_delay[i] = wide_delay[i+1];

  wide_delay[WIDE_ZEROS] = sample; // unfiltered sample in
  sum = 0.0f;

  for (i = 0; i <= WIDE_ZEROS; i++)
    sum += (wide_coeffs[i] * wide_delay[i]);

  return (sum / WIDE_GAIN); // filtered sample out
}

/* Digital filter designed by mkfilter/mkshape/gencode   A.J. Fisher
   Command line: ./mkshape -r 3e-02 2.0e-01 161 -w -l */

#define NARROW_ZEROS 160
#define NARROW_GAIN   1.667661347e+01

static float narrow_delay[NARROW_ZEROS+1];

static float narrow_coeffs[] =
  { -0.0008937361, -0.0006060463, -0.0002610777, +0.0001388685,
    +0.0005895134, +0.0010834489, +0.0016089429, +0.0021488529,
    +0.0026798112, +0.0031718474, +0.0035885954, +0.0038882015,
    +0.0040250058, +0.0039520113, +0.0036240877, +0.0030017876,
    +0.0020555827, +0.0007702612, -0.0008508232, -0.0027819978,
    -0.0049723767, -0.0073441785, -0.0097925776, -0.0121873451,
    -0.0143764522, -0.0161916977, -0.0174562979, -0.0179942389,
    -0.0176410542, -0.0162555545, -0.0137319238, -0.0100114946,
    -0.0050934566, +0.0009562709, +0.0079987576, +0.0158190569,
    +0.0241270514, +0.0325625707, +0.0407050045, +0.0480874116,
    +0.0542148808, +0.0585866417, +0.0607211800, +0.0601833785,
    +0.0566125106, +0.0497497630, +0.0394638719, +0.0257734307,
    +0.0088644753, -0.0108979272, -0.0329651659, -0.0566084668,
    -0.0809306646, -0.1048864974, -0.1273111635, -0.1469564706,
    -0.1625335158, -0.1727604614, -0.1764136562, -0.1723800976,
    -0.1597090566, -0.1376606137, -0.1057488743, -0.0637777621,
    -0.0118675180, +0.0495296424, +0.1196258520, +0.1973065618,
    +0.2811523036, +0.3694728478, +0.4603528199, +0.5517073241,
    +0.6413456604, +0.7270408344, +0.8066022607, +0.8779488796,
    +0.9391798334, +0.9886399094, +1.0249771313, +1.0471901805,
    +1.0546637192, +1.0471901805, +1.0249771313, +0.9886399094,
    +0.9391798334, +0.8779488796, +0.8066022607, +0.7270408344,
    +0.6413456604, +0.5517073241, +0.4603528199, +0.3694728478,
    +0.2811523036, +0.1973065618, +0.1196258520, +0.0495296424,
    -0.0118675180, -0.0637777621, -0.1057488743, -0.1376606137,
    -0.1597090566, -0.1723800976, -0.1764136562, -0.1727604614,
    -0.1625335158, -0.1469564706, -0.1273111635, -0.1048864974,
    -0.0809306646, -0.0566084668, -0.0329651659, -0.0108979272,
    +0.0088644753, +0.0257734307, +0.0394638719, +0.0497497630,
    +0.0566125106, +0.0601833785, +0.0607211800, +0.0585866417,
    +0.0542148808, +0.0480874116, +0.0407050045, +0.0325625707,
    +0.0241270514, +0.0158190569, +0.0079987576, +0.0009562709,
    -0.0050934566, -0.0100114946, -0.0137319238, -0.0162555545,
    -0.0176410542, -0.0179942389, -0.0174562979, -0.0161916977,
    -0.0143764522, -0.0121873451, -0.0097925776, -0.0073441785,
    -0.0049723767, -0.0027819978, -0.0008508232, +0.0007702612,
    +0.0020555827, +0.0030017876, +0.0036240877, +0.0039520113,
    +0.0040250058, +0.0038882015, +0.0035885954, +0.0031718474,
    +0.0026798112, +0.0021488529, +0.0016089429, +0.0010834489,
    +0.0005895134, +0.0001388685, -0.0002610777, -0.0006060463,
    -0.0008937361,
  };

float narrow_rrc_filter(float sample) {
  float sum; int i;
  
  for (i = 0; i < NARROW_ZEROS; i++)
      narrow_delay[i] = narrow_delay[i+1];

  narrow_delay[NARROW_ZEROS] = sample; // unfiltered sample in
  sum = 0.0f;

  for (i = 0; i <= NARROW_ZEROS; i++)
    sum += (narrow_coeffs[i] * narrow_delay[i]);

  return (sum / NARROW_GAIN); // filtered sample out
}

float buf[BUF_SIZE];
int r = 0;

void print_usage() {
    fprintf(stderr,
        "rrc_filter version %s\n\n"
        "Usage: rrc_filter [options]\n\n"
        "Available options:\n"
        " -h, --help      show this message\n"
        " -v, --version   print version and exit\n"
        " -n, --narrow    use narrow (6.25kHz) filter version\n",
        VERSION
    );
}

int main(int argc, char** argv) {
    int c;
    bool narrow = false;
    static struct option long_options[] = {
        {"help", no_argument, NULL, 'h'},
        {"version", no_argument, NULL, 'v'},
        {"narrow", no_argument, NULL, 'n'},
        { NULL, 0, NULL, 0 }
    };
    while ((c = getopt_long(argc, argv, "hvn", long_options, NULL)) != -1) {
        switch (c) {
            case 'v':
                print_version();
                return 0;
            case 'h':
                print_usage();
                return 0;
            case 'n':
                narrow = true;
                break;
        }
    }
    if (narrow) {
        while ((r = fread(buf, 4, BUF_SIZE, stdin)) > 0) {
            int i;
            for (i = 0; i < r; i++) {
                buf[i] = narrow_rrc_filter(buf[i]);
            }
            fwrite(buf, 4, r, stdout);
            fflush(stdout);
        }
    } else {
        while ((r = fread(buf, 4, BUF_SIZE, stdin)) > 0) {
            int i;
            for (i = 0; i < r; i++) {
                buf[i] = wide_rrc_filter(buf[i]);
            }
            fwrite(buf, 4, r, stdout);
            fflush(stdout);
        }
    }

    return 0;
}
