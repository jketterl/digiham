#include "bch_31_21.h"

uint32_t bch_31_21_parity_check_matrix[] = {
    0b1001010010011110101011000000000,
    0b1101111011010001111110100000000,
    0b1111101111110110010100010000000,
    0b0111110111111011001010001000000,
    0b1010101001100011001110000100000,
    0b1100000110101111001100000010000,
    0b0110000011010111100110000001000,
    0b1010010011110101011000000000100,
    0b0101001001111010101100000000010,
    0b0010100100111101010110000000001
};

struct correction {
    uint16_t syndrome;
    uint32_t error_pattern;
};

// generated by applying possible combinations of errors
static struct correction corrections[] = {
    { 1, 1 },
    { 2, 2 },
    { 3, 3 },
    { 4, 4 },
    { 5, 5 },
    { 6, 6 },
    { 8, 8 },
    { 9, 9 },
    { 10, 10 },
    { 12, 12 },
    { 16, 16 },
    { 17, 17 },
    { 18, 18 },
    { 20, 20 },
    { 24, 24 },
    { 32, 32 },
    { 33, 33 },
    { 34, 34 },
    { 36, 36 },
    { 40, 40 },
    { 48, 48 },
    { 64, 64 },
    { 65, 65 },
    { 66, 66 },
    { 68, 68 },
    { 72, 72 },
    { 80, 80 },
    { 96, 96 },
    { 128, 128 },
    { 129, 129 },
    { 130, 130 },
    { 132, 132 },
    { 136, 136 },
    { 144, 144 },
    { 160, 160 },
    { 192, 192 },
    { 256, 256 },
    { 257, 257 },
    { 258, 258 },
    { 260, 260 },
    { 264, 264 },
    { 272, 272 },
    { 288, 288 },
    { 320, 320 },
    { 384, 384 },
    { 512, 512 },
    { 513, 513 },
    { 514, 514 },
    { 516, 516 },
    { 520, 520 },
    { 528, 528 },
    { 544, 544 },
    { 576, 576 },
    { 640, 640 },
    { 768, 768 },
    { 873, 1024 },
    { 872, 1025 },
    { 875, 1026 },
    { 877, 1028 },
    { 865, 1032 },
    { 889, 1040 },
    { 841, 1056 },
    { 809, 1088 },
    { 1001, 1152 },
    { 617, 1280 },
    { 361, 1536 },
    { 443, 2048 },
    { 442, 2049 },
    { 441, 2050 },
    { 447, 2052 },
    { 435, 2056 },
    { 427, 2064 },
    { 411, 2080 },
    { 507, 2112 },
    { 315, 2176 },
    { 187, 2304 },
    { 955, 2560 },
    { 722, 3072 },
    { 886, 4096 },
    { 887, 4097 },
    { 884, 4098 },
    { 882, 4100 },
    { 894, 4104 },
    { 870, 4112 },
    { 854, 4128 },
    { 822, 4160 },
    { 1014, 4224 },
    { 630, 4352 },
    { 374, 4608 },
    { 31, 5120 },
    { 717, 6144 },
    { 389, 8192 },
    { 388, 8193 },
    { 391, 8194 },
    { 385, 8196 },
    { 397, 8200 },
    { 405, 8208 },
    { 421, 8224 },
    { 453, 8256 },
    { 261, 8320 },
    { 133, 8448 },
    { 901, 8704 },
    { 748, 9216 },
    { 62, 10240 },
    { 755, 12288 },
    { 778, 16384 },
    { 779, 16385 },
    { 776, 16386 },
    { 782, 16388 },
    { 770, 16392 },
    { 794, 16400 },
    { 810, 16416 },
    { 842, 16448 },
    { 906, 16512 },
    { 522, 16640 },
    { 266, 16896 },
    { 99, 17408 },
    { 689, 18432 },
    { 124, 20480 },
    { 655, 24576 },
    { 381, 32768 },
    { 380, 32769 },
    { 383, 32770 },
    { 377, 32772 },
    { 373, 32776 },
    { 365, 32784 },
    { 349, 32800 },
    { 317, 32832 },
    { 509, 32896 },
    { 125, 33024 },
    { 893, 33280 },
    { 532, 33792 },
    { 198, 34816 },
    { 523, 36864 },
    { 248, 40960 },
    { 631, 49152 },
    { 762, 65536 },
    { 763, 65537 },
    { 760, 65538 },
    { 766, 65540 },
    { 754, 65544 },
    { 746, 65552 },
    { 730, 65568 },
    { 698, 65600 },
    { 634, 65664 },
    { 1018, 65792 },
    { 250, 66048 },
    { 403, 66560 },
    { 833, 67584 },
    { 396, 69632 },
    { 895, 73728 },
    { 496, 81920 },
    { 903, 98304 },
    { 669, 131072 },
    { 668, 131073 },
    { 671, 131074 },
    { 665, 131076 },
    { 661, 131080 },
    { 653, 131088 },
    { 701, 131104 },
    { 733, 131136 },
    { 541, 131200 },
    { 925, 131328 },
    { 157, 131584 },
    { 500, 132096 },
    { 806, 133120 },
    { 491, 135168 },
    { 792, 139264 },
    { 407, 147456 },
    { 992, 163840 },
    { 103, 196608 },
    { 595, 262144 },
    { 594, 262145 },
    { 593, 262146 },
    { 599, 262148 },
    { 603, 262152 },
    { 579, 262160 },
    { 627, 262176 },
    { 531, 262208 },
    { 723, 262272 },
    { 851, 262400 },
    { 83, 262656 },
    { 314, 263168 },
    { 1000, 264192 },
    { 293, 266240 },
    { 982, 270336 },
    { 345, 278528 },
    { 814, 294912 },
    { 169, 327680 },
    { 206, 393216 },
    { 975, 524288 },
    { 974, 524289 },
    { 973, 524290 },
    { 971, 524292 },
    { 967, 524296 },
    { 991, 524304 },
    { 1007, 524320 },
    { 911, 524352 },
    { 847, 524416 },
    { 719, 524544 },
    { 463, 524800 },
    { 166, 525312 },
    { 628, 526336 },
    { 185, 528384 },
    { 586, 532480 },
    { 197, 540672 },
    { 690, 557056 },
    { 309, 589824 },
    { 338, 655360 },
    { 412, 786432 },
    { 247, 1048576 },
    { 246, 1048577 },
    { 245, 1048578 },
    { 243, 1048580 },
    { 255, 1048584 },
    { 231, 1048592 },
    { 215, 1048608 },
    { 183, 1048640 },
    { 119, 1048704 },
    { 503, 1048832 },
    { 759, 1049088 },
    { 926, 1049600 },
    { 332, 1050624 },
    { 897, 1052672 },
    { 370, 1056768 },
    { 1021, 1064960 },
    { 394, 1081344 },
    { 525, 1114112 },
    { 618, 1179648 },
    { 676, 1310720 },
    { 824, 1572864 },
    { 494, 2097152 },
    { 495, 2097153 },
    { 492, 2097154 },
    { 490, 2097156 },
    { 486, 2097160 },
    { 510, 2097168 },
    { 462, 2097184 },
    { 430, 2097216 },
    { 366, 2097280 },
    { 238, 2097408 },
    { 1006, 2097664 },
    { 647, 2098176 },
    { 85, 2099200 },
    { 664, 2101248 },
    { 107, 2105344 },
    { 740, 2113536 },
    { 147, 2129920 },
    { 788, 2162688 },
    { 883, 2228224 },
    { 957, 2359296 },
    { 545, 2621440 },
    { 281, 3145728 },
    { 988, 4194304 },
    { 989, 4194305 },
    { 990, 4194306 },
    { 984, 4194308 },
    { 980, 4194312 },
    { 972, 4194320 },
    { 1020, 4194336 },
    { 924, 4194368 },
    { 860, 4194432 },
    { 732, 4194560 },
    { 476, 4194816 },
    { 181, 4195328 },
    { 615, 4196352 },
    { 170, 4198400 },
    { 601, 4202496 },
    { 214, 4210688 },
    { 673, 4227072 },
    { 294, 4259840 },
    { 321, 4325376 },
    { 399, 4456448 },
    { 19, 4718592 },
    { 811, 5242880 },
    { 562, 6291456 },
    { 209, 8388608 },
    { 208, 8388609 },
    { 211, 8388610 },
    { 213, 8388612 },
    { 217, 8388616 },
    { 193, 8388624 },
    { 241, 8388640 },
    { 145, 8388672 },
    { 81, 8388736 },
    { 465, 8388864 },
    { 721, 8389120 },
    { 952, 8389632 },
    { 362, 8390656 },
    { 935, 8392704 },
    { 340, 8396800 },
    { 987, 8404992 },
    { 428, 8421376 },
    { 555, 8454144 },
    { 588, 8519680 },
    { 642, 8650752 },
    { 798, 8912896 },
    { 38, 9437184 },
    { 319, 10485760 },
    { 781, 12582912 },
    { 418, 16777216 },
    { 419, 16777217 },
    { 416, 16777218 },
    { 422, 16777220 },
    { 426, 16777224 },
    { 434, 16777232 },
    { 386, 16777248 },
    { 482, 16777280 },
    { 290, 16777344 },
    { 162, 16777472 },
    { 930, 16777728 },
    { 715, 16778240 },
    { 25, 16779264 },
    { 724, 16781312 },
    { 39, 16785408 },
    { 680, 16793600 },
    { 223, 16809984 },
    { 856, 16842752 },
    { 831, 16908288 },
    { 1009, 17039360 },
    { 621, 17301504 },
    { 341, 17825792 },
    { 76, 18874368 },
    { 638, 20971520 },
    { 371, 25165824 },
    { 836, 33554432 },
    { 837, 33554433 },
    { 838, 33554434 },
    { 832, 33554436 },
    { 844, 33554440 },
    { 852, 33554448 },
    { 868, 33554464 },
    { 772, 33554496 },
    { 964, 33554560 },
    { 580, 33554688 },
    { 324, 33554944 },
    { 45, 33555456 },
    { 767, 33556480 },
    { 50, 33558528 },
    { 705, 33562624 },
    { 78, 33570816 },
    { 569, 33587200 },
    { 446, 33619968 },
    { 473, 33685504 },
    { 279, 33816576 },
    { 139, 34078720 },
    { 947, 34603008 },
    { 682, 35651584 },
    { 152, 37748736 },
    { 917, 41943040 },
    { 742, 50331648 },
    { 481, 67108864 },
    { 480, 67108865 },
    { 483, 67108866 },
    { 485, 67108868 },
    { 489, 67108872 },
    { 497, 67108880 },
    { 449, 67108896 },
    { 417, 67108928 },
    { 353, 67108992 },
    { 225, 67109120 },
    { 993, 67109376 },
    { 648, 67109888 },
    { 90, 67110912 },
    { 663, 67112960 },
    { 100, 67117056 },
    { 747, 67125248 },
    { 156, 67141632 },
    { 795, 67174400 },
    { 892, 67239936 },
    { 946, 67371008 },
    { 558, 67633152 },
    { 278, 68157440 },
    { 15, 69206016 },
    { 573, 71303168 },
    { 304, 75497472 },
    { 67, 83886080 },
    { 677, 100663296 },
    { 962, 134217728 },
    { 963, 134217729 },
    { 960, 134217730 },
    { 966, 134217732 },
    { 970, 134217736 },
    { 978, 134217744 },
    { 994, 134217760 },
    { 898, 134217792 },
    { 834, 134217856 },
    { 706, 134217984 },
    { 450, 134218240 },
    { 171, 134218752 },
    { 633, 134219776 },
    { 180, 134221824 },
    { 583, 134225920 },
    { 200, 134234112 },
    { 703, 134250496 },
    { 312, 134283264 },
    { 351, 134348800 },
    { 401, 134479872 },
    { 13, 134742016 },
    { 821, 135266304 },
    { 556, 136314880 },
    { 30, 138412032 },
    { 787, 142606336 },
    { 608, 150994944 },
    { 134, 167772160 },
    { 547, 201326592 },
    { 237, 268435456 },
    { 236, 268435457 },
    { 239, 268435458 },
    { 233, 268435460 },
    { 229, 268435464 },
    { 253, 268435472 },
    { 205, 268435488 },
    { 173, 268435520 },
    { 109, 268435584 },
    { 493, 268435712 },
    { 749, 268435968 },
    { 900, 268436480 },
    { 342, 268437504 },
    { 923, 268439552 },
    { 360, 268443648 },
    { 999, 268451840 },
    { 400, 268468224 },
    { 535, 268500992 },
    { 624, 268566528 },
    { 702, 268697600 },
    { 802, 268959744 },
    { 26, 269484032 },
    { 259, 270532608 },
    { 817, 272629760 },
    { 60, 276824064 },
    { 335, 285212672 },
    { 937, 301989888 },
    { 268, 335544320 },
    { 815, 402653184 },
    { 474, 536870912 },
    { 475, 536870913 },
    { 472, 536870914 },
    { 478, 536870916 },
    { 466, 536870920 },
    { 458, 536870928 },
    { 506, 536870944 },
    { 410, 536870976 },
    { 346, 536871040 },
    { 218, 536871168 },
    { 986, 536871424 },
    { 691, 536871936 },
    { 97, 536872960 },
    { 684, 536875008 },
    { 95, 536879104 },
    { 720, 536887296 },
    { 167, 536903680 },
    { 800, 536936448 },
    { 839, 537001984 },
    { 905, 537133056 },
    { 533, 537395200 },
    { 301, 537919488 },
    { 52, 538968064 },
    { 518, 541065216 },
    { 267, 545259520 },
    { 120, 553648128 },
    { 670, 570425344 },
    { 59, 603979776 },
    { 536, 671088640 },
    { 311, 805306368 },
    { 948, 1073741824 },
    { 949, 1073741825 },
    { 950, 1073741826 },
    { 944, 1073741828 },
    { 956, 1073741832 },
    { 932, 1073741840 },
    { 916, 1073741856 },
    { 1012, 1073741888 },
    { 820, 1073741952 },
    { 692, 1073742080 },
    { 436, 1073742336 },
    { 221, 1073742848 },
    { 527, 1073743872 },
    { 194, 1073745920 },
    { 561, 1073750016 },
    { 190, 1073758208 },
    { 713, 1073774592 },
    { 334, 1073807360 },
    { 297, 1073872896 },
    { 487, 1074003968 },
    { 123, 1074266112 },
    { 835, 1074790400 },
    { 602, 1075838976 },
    { 104, 1077936128 },
    { 869, 1082130432 },
    { 534, 1090519040 },
    { 240, 1107296256 },
    { 597, 1140850688 },
    { 118, 1207959552 },
    { 857, 1342177280 },
    { 622, 1610612736 }
};

uint16_t bch_31_21_parity(uint32_t* data) {
    /*
    int i;
    uint32_t poly = 0b11101101001;
    uint16_t parity = 0;
    for (int i = 0; i < (21 - 11); i++) {
        parity ^= *data & (poly >> i);
    }
    return parity;
    */
    uint16_t parity = 0;

    uint8_t k;
    for (k = 0; k < 10; k++) {
        uint8_t bit = 0, l;
        for (l = 0; l < 31; l++) {
            if ((bch_31_21_parity_check_matrix[k] >> l) & 1) {
                bit ^= ((*data >> l) & 1);
            }
        }

        parity = (parity << 1) | (bit & 1);
    }

    return parity;
}

bool bch_31_21(uint32_t* data) {
    uint16_t parity = bch_31_21_parity(data);

    if (parity == 0) return true;

    int num_corrections = sizeof(corrections)/sizeof(corrections[0]);
    for (int i = 0; i < num_corrections; i++) {
        if (corrections[i].syndrome == parity) {
            *data = *data ^ corrections[i].error_pattern;
            return true;
        }
    }

    return false;
}